<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core">
	<h:form id="conditionsDetailForm">
		<p:growl id="message" showDetail="true" />
		<p:panel id="conditionsDetailPanel" style="width:100%;"
			toggleable="#{controller.hasRateFileSelected}"
			collapsed="#{controller.collapseConditionsDetailGrid}"
			header="Terms and conditions">

			<p:dataTable editable="#{canEdit}" value="#{conditions}"
				var="condition" editMode="row" emptyMessage="No conditions found."
				id="conditionTable">
				<p:column headerText="Key" width="15%">
					<h:outputText value="#{condition.translatedKey}" />
				</p:column>
				<p:column headerText="Condition type" width="15%">
					<h:outputText value="#{condition.conditionType}" />
				</p:column>
				<p:column headerText="Value">
					<p:outputPanel rendered="#{condition.calculationCondition}">
						<h:outputText
							value="#{condition.value} #{condition.calculationValueType.suffix}" />
					</p:outputPanel>
					<p:outputPanel rendered="#{!condition.calculationCondition}">
						<h:outputText
							value="EN: #{condition.englishTranslation.translation}" />
						<br />
						<h:outputText
							value="NL: #{condition.dutchTranslation.translation}" />
						<br />
						<h:outputText
							value="FR: #{condition.frenchTranslation.translation}" />
						<br />
						<h:outputText
							value="DE: #{condition.germanTranslation.translation}" />
						<br />
					</p:outputPanel>
				</p:column>
				<p:column headerText="Standard option" style="width:128px;">
					<p:selectBooleanCheckbox value="#{condition.standardSelected}"
						disabled="true" />
				</p:column>
				<p:column style="width:115px;" rendered="#{canEdit}">
					<p:commandButton icon="ui-icon-pencil" title="Edit"
						id="editConditionButton" styleClass="navButton"
						actionListener="#{controller.setupEditCondition(condition)}"
						ajax="true" immediate="true" update=":editConditionForm" />
					<p:tooltip id="editConditionTip" for="editConditionButton"
						value="Edit the condition" />

					<p:commandButton styleClass="navButton" icon="ui-icon-trash"
						title="Delete" id="deleteConditionButton"
						actionListener="#{controller.deleteCondition(condition)}"
						ajax="true" immediate="true" update=":conditionsDetailForm">
						<p:confirm header="Confirm delete"
							message="Are you sure you want to delete?" icon="ui-icon-alert" />
					</p:commandButton>
					<p:tooltip id="deleteConditionTip" for="deleteConditionButton"
						value="Delete the condition" />
				</p:column>
			</p:dataTable>

			<p:panel style="margin-top:10px;" rendered="#{canEdit}">
				<p:commandButton value="Add condition" icon="ui-icon-pencil"
					actionListener="#{controller.setupAddCondition}" ajax="true"
					immediate="true" update=":editConditionForm"
					id="addConditionButton" styleClass="navButton" />
				<p:tooltip id="addConditionTip" for="addConditionButton"
					value="Add a condition" />
			</p:panel>
		</p:panel>
	</h:form>

	<h:form id="editConditionForm">
		<p:dialog id="editDialog" header="Edit condition"
			widgetVar="editConditionDialog" width="50%" height="50%"
			dynamic="true">
			<p:panel style="width:100%; margin:auto;">
				<p:panelGrid columns="2" style="width:100%;margin-top:10px;">
					<h:outputLabel value="Selected key" />
					<h:outputLabel style="font-weight:bold;"
						rendered="#{controller.editMode}"
						value="#{controller.selectedCondition.translatedKey}" />
					<p:selectOneMenu
						value="#{controller.selectedCondition.conditionKey}"
						rendered="#{!controller.editMode}" style="width:200px;">
						<f:selectItem itemValue="#{null}" itemLabel="Select key" />
						<f:selectItems
							value="#{controller.availableTranslationKeysForSelectedRateFile}" />
						<p:ajax listener="#{controller.loadConditionBasedOnKey}"
							update=":editConditionForm" />
					</p:selectOneMenu>

					<h:outputLabel value="New value:"
						rendered="#{controller.selectedCondition.calculationCondition}" />
					<p:inputText style="width:100%;"
						value="#{controller.selectedCondition.value}"
						rendered="#{controller.selectedCondition.calculationCondition}" />

					<c:forEach items="#{controller.selectedCondition.translations}"
						var="translation">
						<h:outputText value="#{translation.language}" />
						<p:inputText style="width:100%;"
							value="#{translation.translation}" />
					</c:forEach>

					<h:outputLabel value="Standard selected:" />
					<p:selectBooleanCheckbox
						value="#{controller.selectedCondition.standardSelected}" />
				</p:panelGrid>
				<p:panel style="margin-top:20px;">
					<p:commandButton value="Cancel" id="cancelEditConditionButton"
						onclick="PF('editConditionDialog').hide();" styleClass="navButton" />
					<p:tooltip id="cancelEditConditionButtonTip"
						for="cancelEditConditionButton" value="Undo all changes." />
					<p:commandButton style="margin-left:20px;" value="Save"
						oncomplete="handleEditConditionRequest(xhr, status, args)"
						actionListener="#{controller.saveEditCondition}"
						styleClass="navButton" id="saveEditConditionButton"
						update=":conditionsDetailForm :editConditionForm" />
					<p:tooltip id="saveEditConditionButtonTip"
						for="saveEditConditionButton" value="Save the changes made." />
				</p:panel>
			</p:panel>
		</p:dialog>
	</h:form>

	<script type="text/javascript">
		function handleEditConditionRequest(xhr, status, args) {
			if (args.validationFailed) {
				PF('editConditionDialog').jq.effect("shake", {
					times : 5
				}, 100);
			} else {
				PF('editConditionDialog').hide();
			}
		}
	</script>
</ui:composition>